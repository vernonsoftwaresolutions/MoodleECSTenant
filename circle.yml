--- 
machine: 
  python: 
    version: "2.7.11"
  ruby: 
    version: "2.4.0"
  services: 
    - docker

dependencies: 
  override: 
    - "docker info"
 #   - "docker build --rm=false -t vernonsoftwaresolutions/moodlesingleinstance:$CIRCLE_BUILD_NUM ."

test: 
  post: 
  #  - "docker run -d -p 80:80 -e \"VIRTUAL_HOST=localhost\" --name moodle vernonsoftwaresolutions/moodlesingleinstance:$CIRCLE_BUILD_NUM; sleep 10"
 ##   - "docker ps"
  #  - "docker images"
  #  - "docker port moodle"
    - "curl -L www.google.com"
deployment: 
  development: 
    branch: moodle29
    commands: 
      - "docker login -e $DOCKER_EMAIL -u $DOCKER_USER -p $DOCKER_PASS"
    #  - "docker push vernonsoftwaresolutions/moodlesingleinstance:$CIRCLE_BUILD_NUM"
      - "aws configure set default.region us-east-1"
      - "aws configure set default.output json"
      - "aws cloudformation package --template-file moodletenant.yml --output-template-file moodletenant-output.yml --s3-bucket circleci.deployables"
      - "aws cloudformation deploy --template-file moodletenant-output.yml --capabilities CAPABILITY_IAM --stack-name moodle-ecs-brad --parameter-overrides Version=12 ecscluster=moodle-ecs-single-ECSCluster-1GO8PSGOCUMFY ecslblistener=arn:aws:elasticloadbalancing:us-east-1:417615409974:listener/app/ECSLB/3e4551a3d5add57d/14b1315b80b22a6b ecslbarn=arn:aws:elasticloadbalancing:us-east-1:417615409974:targetgroup/ECSTARGRP/08e87065c62e095a ecslbdnsname=ECSLB-931880790.us-east-1.elb.amazonaws.com ecslbhostedzoneid=Z35SXDOTRQ7X7K DNSName=brad.vssdevelopment.com HostedZoneName=vssdevelopment.com."