--- 
machine: 
  python: 
    version: "2.7.11"
  ruby: 
    version: "2.4.0"
  services: 
    - docker

dependencies: 
  override: 
    - "aws configure set default.region us-east-1"
    - "aws configure set default.output json"

test: 
  post: 
    - "aws cloudformation validate-template --template-body file://moodletenant.yml"


deployment: 
  development: 
    branch: master
    commands: 
      - "aws cloudformation package --template-file moodletenant.yml --output-template-file moodletenant-output.yml --s3-bucket circleci.deployables"
      - "aws cloudformation deploy --template-file moodletenant-output.yml --capabilities CAPABILITY_IAM --stack-name moodle-ecs-tenant --parameter-overrides VpcId=vpc-c7aa77be Version=$CIRCLE_BUILD_NUM ecscluster=moodle-ecs-single-ECSCluster-1TNQMEK91G4XK ecslbarn=arn:aws:elasticloadbalancing:us-east-1:417615409974:loadbalancer/app/ECSLB/fd450f43b12193ee	ecslbdnsname=ECSLB-110201755.us-east-1.elb.amazonaws.com	 ecslbhostedzoneid=Z35SXDOTRQ7X7K alblistener=arn:aws:elasticloadbalancing:us-east-1:417615409974:listener/app/ECSLB/fd450f43b12193ee/3da8d47f1061f91a HostedZoneName=vssdevelopment.com  ClientName=brad"
      #just send basic test
      - "curl http://brad.vssdevelopment.com/"
      - "aws cloudformation package --template-file moodletenant.yml --output-template-file moodletenant-output.yml --s3-bucket circleci.deployables"
      - "aws cloudformation deploy --template-file moodletenant-output.yml --capabilities CAPABILITY_IAM --stack-name moodle-ecs-tenant1 --parameter-overrides VpcId=vpc-c7aa77be Version=$CIRCLE_BUILD_NUM ecscluster=moodle-ecs-single-ECSCluster-1TNQMEK91G4XK	ecslbarn=arn:aws:elasticloadbalancing:us-east-1:417615409974:loadbalancer/app/ECSLB/fd450f43b12193ee ecslbdnsname=ECSLB-110201755.us-east-1.elb.amazonaws.com	 ecslbhostedzoneid=Z35SXDOTRQ7X7K alblistener=arn:aws:elasticloadbalancing:us-east-1:417615409974:listener/app/ECSLB/fd450f43b12193ee/3da8d47f1061f91a HostedZoneName=vssdevelopment.com  ClientName=alec"
      #just send basic test
      - "curl http://alec.vssdevelopment.com/"